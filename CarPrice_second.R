#Data Source : https://www.kaggle.com/orgesleka/used-cars-database file: autos.csv

#MED Project
# dependent var(Y)= price
# independent Var(X)= price, vehicleType, yearOfRegistration, 
                    # gearbox, powerPS, model, kilometer, fuelType, 
                    # brand, notRepairedDamage
library(markdown)
library(dplyr)
library (ggplot2)
library(tidyverse)
library(psych)
library(GPArotation)
library(knitr)
#install.packages("Metrics")
library(caret)
library(readxl)
#install.packages("rio")
library(rio)
#install.packages("visualize")
library(visualize)
#install.packages("writexl")
library(writexl)
#install.packages("xlsReadWrite")
install.packages("xlsx")
library("xlsx") 



#Choose Read data

file_csv <- read.csv(file.choose())
file_csv



x <- 1*nrow(file_csv)
if(x > 0) { 
     carPrice<-print.data.frame(file_csv)
  
} else { 
       print(paste("Choose the file with pattern .csv")) 
       carPrice <- read.csv(file.choose())
}

#show data
View(carPrice)
str(carPrice)
head(carPrice)
glimpse(carPrice)
nrow(carPrice)

## Choose only atribiutes for analyze from data
carPrice_selected <- select(carPrice, price, vehicleType, yearOfRegistration, gearbox, powerPS, model, kilometer, fuelType, brand, notRepairedDamage)
View(carPrice_selected)
str(carPrice_selected)
head(carPrice_selected)
glimpse(carPrice_selected)
nrow(carPrice_selected)
min(carPrice_selected$price)

## Clean the data

## Change 0 to NA in all data
carPrice_selected[carPrice_selected == 0] <- NA
carPrice_selected

## Change empty cell to NA in all data
carPrice_selected[carPrice_selected == ""] <- NA
carPrice_selected

## Change "," to NA in all data
carPrice_selected[carPrice_selected == ","] <- NA
carPrice_selected

## Delete rows and column with NA cell
carPrice_clean_NA <-carPrice_selected[complete.cases(carPrice_selected),]
carPrice_clean_NA
view(carPrice_clean_NA)
glimpse(carPrice_clean_NA)

## Filter data 
carPrice_clean_0 <- filter(carPrice_clean_NA, price > 499,  powerPS > 5 , yearOfRegistration > 0, kilometer > 0 )
carPrice_clean_0
nrow(carPrice_clean_0)
min(carPrice_clean_0$price)
min(carPrice_clean_0$powerPS)
glimpse(carPrice_clean_0)

#export clean file from csv to xlsx

library(rio)
export(list(carPrice_clean_0 = carPrice_clean_0, iris=iris), "carPrice_clean_0.xlsx")
 
carPrice_Clean_xlsx <- read_xlsx("carPrice_clean_0.xlsx")
carPrice_1 <- carPrice_Clean_xlsx
glimpse(carPrice_1)
head(carPrice_1)


##Checking categorical values
#fuelType
fuelTypeOnly_1 <- carPrice_1 %>% select(fuelType)
fueltypetrial_1 <- as.character(unique(fuelTypeOnly_1))
fueltypetrial_1

#model
modelOnly <- carPrice_1 %>% select(model)
modeltrial <- as.character(unique(modelOnly))
modeltrial

#vehicleType
vehicleTypeOnly <- carPrice_1 %>% select(vehicleType)
vehicleTypetrial <- as.character(unique(vehicleTypeOnly))
vehicleTypetrial

#gearbox
gearboxOnly <- carPrice_1 %>% select(gearbox)
gearboxtrial <- as.character(unique(gearboxOnly))
gearboxtrial

#brand
brandOnly <- carPrice_1 %>% select(brand)
brandtrial <- as.character(unique(brandOnly))
brandtrial

#notRepairedDamage
notRepairedDamageOnly <- carPrice_1 %>% select(notRepairedDamage)
notRepairedDamagetrial <- as.character(unique(notRepairedDamageOnly))
notRepairedDamagetrial

print('Checking categorical values:')
fueltypetrial_1
modeltrial
vehicleTypetrial
gearboxtrial
brandtrial
notRepairedDamagetrial

glimpse(carPrice_1)
##function changing fueltype from categorical into numerical
fueltypeFunc_1 <- function(carPrice_1, fueltypetrial_1){
  factor(carPrice_1, levels = fueltypetrial_1, labels = fueltypetrial_1, ordered = TRUE)
}

glimpse(carPrice_1)
#converting fueltype into numerical var
trial <- map_df(fuelTypeOnly_1, fueltypeFunc_1) %>% glimpse
trial <- map_df(trial, as.numeric)%>% glimpse
carPrice_1[8]<- trial
glimpse(carPrice_1)


##function changing model from categorical into numerical
modelFunc <- function(carPrice_1, modeltrial){
  factor(carPrice_1, levels = modeltrial, labels = modeltrial, ordered = TRUE)
}

glimpse(carPrice_1)
#converting model into numerical var
trial_2 <- map_df(modelOnly, modelFunc) %>% glimpse
trial_2 <- map_df(trial_2, as.numeric)%>% glimpse
carPrice_1[6]<- trial_2
glimpse(carPrice_1)

##function changing vehicleType from categorical into numerical
vehicleTypetrialFunc <- function(carPrice_1, vehicleTypetrial){
  factor(carPrice_1, levels = vehicleTypetrial, labels = vehicleTypetrial, ordered = TRUE)
}

glimpse(carPrice_1)
#converting vehicleType into numerical var
trial_3 <- map_df(vehicleTypeOnly, vehicleTypetrialFunc) %>% glimpse
trial_3 <- map_df(trial_3, as.numeric)%>% glimpse
carPrice_1[2]<- trial_3
glimpse(carPrice_1)


##function changing gearbox from categorical into numerical
gearboxtrialFunc <- function(carPrice_1, gearboxtrial){
  factor(carPrice_1, levels = gearboxtrial, labels = gearboxtrial, ordered = TRUE)
}

glimpse(carPrice_1)
#converting gearbox into numerical var
trial_4 <- map_df(gearboxOnly, gearboxtrialFunc) %>% glimpse
trial_4 <- map_df(trial_4, as.numeric)%>% glimpse
carPrice_1[4]<- trial_4
glimpse(carPrice_1)

##function changing brand from categorical into numerical
brandtrialFunc <- function(carPrice_1, brandtrial){
  factor(carPrice_1, levels = brandtrial, labels = brandtrial, ordered = TRUE)
}

glimpse(carPrice_1)
#converting brand into numerical var
trial_5 <- map_df(brandOnly, brandtrialFunc) %>% glimpse
trial_5 <- map_df(trial_5, as.numeric)%>% glimpse
carPrice_1[9]<- trial_5
glimpse(carPrice_1)

##function changing notRepairedDamage from categorical into numerical
notRepairedDamagetrialFunc <- function(carPrice_1, notRepairedDamagetrial){
  factor(carPrice_1, levels = notRepairedDamagetrial, labels = notRepairedDamagetrial, ordered = TRUE)
}

glimpse(carPrice_1)
#converting notRepairedDamage into numerical var
trial_6 <- map_df(notRepairedDamagetrialOnly, notRepairedDamagetrialFunc) %>% glimpse
trial_6 <- map_df(trial_6, as.numeric)%>% glimpse
carPrice_1[10]<- trial_6
glimpse(carPrice_1)


##removing column
carPriceClean_column <-carPrice_1[c(1,2,3,4,5,6,7,8)]
carPriceClean_column
glimpse(carPriceClean_column)


##Linear Model
linmodel <- lm(carPriceClean_rest$price~carPriceClean_rest$vehicleType+carPriceClean_rest$yearOfRegistration+carPriceClean_rest$gearbox+carPriceClean_rest$powerPS+carPriceClean_rest$model+carPriceClean_rest$kilometer+carPriceClean_rest$fuelType,data = carPriceClean_rest)
summary(linmodel)                  
linmodel
plot(linmodel)
abline(linmodel)

##removing column FuelType
#carPriceClean2 <-carPrice[c(1,2,3,5)]
#carPriceClean2
#glimpse(carPriceClean2)

##Linear Model 2
#linmodel2 <- lm(carPriceClean2$Price~carPriceClean2$EngineCapacity+carPriceClean2$Speed+carPriceClean2$FuelScore,data = carPriceClean2)
#summary(linmodel2)                  
#linmodel2
#plot(linmodel2)
#abline(linmodel2)

mean<-mean(carPriceClean$Price)
mean


#linearequation y= mx+b
#y= predictedPriceVolkswagenGolfGTI
predictedPriceVolkswagenGolfGTI <--58887.488+ (1984*-2.526)+(245 *481.112)+(522*129.323)
predictedPriceVolkswagenGolfGTI

carPriceWithSignificantVar<- carPriceClean[c(1,2,3,5)]
carPriceWithSignificantVar
glimpse(carPriceClean)
glimpse(carPriceWithSignificantVar)


##########################################################
#VAlidation set approach
set.seed(123)
training.samples <- carPriceWithSignificantVar$Price %>%
  createDataPartition(p = 0.8, list = FALSE)

train.data  <- carPriceWithSignificantVar[training.samples, ]
test.data <- carPriceWithSignificantVar[-training.samples, ]
test.data


# Build the model
model1 <- lm(Price ~., data = train.data)
# Make predictions and compute the R2, RMSE and MAE
predictions <- model1 %>% predict(test.data)
#Predicted Value
data.frame(test.data, predictions)
data.frame( R2 = R2(predictions, test.data$Price),
            RMSE = RMSE(predictions, test.data$Price),
            MAE = MAE(predictions, test.data$Price))
print(test.data$Price)
#prediction error rate
RMSE(predictions, test.data$Price)/mean(test.data$Price)
MAE(predictions, test.data$Price)
#sum
summary(model)
model1

#######################################################################

#Leave one out cross validation - LOOCV
# Define training control
  train.control <- trainControl(method = "LOOCV")
# Train the model
modelLOOCV <- train(Price ~., data = carPriceWithSignificantVar, method = "lm",
               trControl = train.control)

# Summarize the results
print(modelLOOCV)
modelLOOCV$pred

#######################################################################

#K-fold cross-validation
# Define training control
set.seed(123) 
train.control <- trainControl(method = "cv", number = 3)
# Train the model
model3 <- train(Price ~., data = carPriceWithSignificantVar, method = "lm",
               trControl = train.control)
# Summarize the results
print(model3)

#######################################################################
# Define training control
set.seed(123)
train.control <- trainControl(method = "repeatedcv", 
                              number = 3, repeats = 10)
# Train the model
model4 <- train(Price ~., data = carPriceWithSignificantVar, method = "lm",
               trControl = train.control)
# Summarize the results
print(model4)

######################################################################
##Multiple Regression PREDICTION 
##using validation set approach
##New obj Volkswagen Golf GTI 1984 230 Benzyna 117000 509
##Czytaj wiecej: https://www.wyborkierowcow.pl/moc-w-przeliczeniu-na-zlotowki-zestawienie/

predict(model1, data.frame("EngineCapacity"=1984, "Speed"=230, "FuelType"=1, "FuelScore"=509),interval= "prediction")

predict(modelLOOCV, data.frame("EngineCapacity"=898, "Speed"=90, "FuelType"=1, "FuelScore"=509), interval= "prediction")

predict(model3, data.frame("EngineCapacity"=1984, "Speed"=230, "FuelType"=1, "FuelScore"=509), interval = "prediction")

predict(model4, data.frame("EngineCapacity"=1984, "Speed"=230, "FuelType"=1, "FuelScore"=509), interval= "prediction")

##########################################################################
##Regresion Tree
#install.packages("rpart")
#install.packages("rpart.plot")
library(rpart)
library(rpart.plot)


carPriceWithSignificantVar<- carPriceClean[c(1,2,3,4,5)]
carPriceWithSignificantVar
glimpse(carPriceWithSignificantVar)


model1 <- rpart(Price ~ .,data= carPriceWithSignificantVar, method= "anova")
model1
rpart.plot(model1, type= 2, digits= 5, fallen.leaves=TRUE)


glimpse(carPriceClean)

carPrice_Price<- carPriceClean[c(1,2,4,5)]
carPrice_Price
glimpse(carPrice_Price)

model2 <- rpart(Price ~ .,data= carPrice_Price,  method= "anova")
model2
rpart.plot(model2, type= 2, digits= 5, fallen.leaves=TRUE)

carPrice_speed<- carPriceClean[c(1,2,3,4,5)]
carPrice_speed
glimpse(carPrice_speed)


model3 <- rpart(EngineCapacity ~ .,data= carPrice_speed, method= "anova")
model3
rpart.plot(model3, type= 2, digits= 5, fallen.leaves=TRUE)


model4 <- rpart(Speed ~ .,data= carPrice_speed, method= "poisson")
model4
rpart.plot(model4, type= 2, digits= 5, fallen.leaves=TRUE)

#I think taht will be very googd describe
model5 <- rpart(EngineCapacity ~ .,data= carPrice_speed, method= "poisson")
model5
rpart.plot(model5, type= 2, digits= 5, fallen.leaves=TRUE)


#write.table(model5, file="ExportedFileName.csv", sep=",")
